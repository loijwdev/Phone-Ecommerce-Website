<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- The above 4 meta tags *must* come first in the head; any other head content must come *after* these tags -->


    <!-- Favicon  -->
    <link rel="icon" href="/img/core-img/favicon.ico">

    <!-- Core Style CSS -->
    <link rel="stylesheet" href="/css/core-style.css">
    <link rel="stylesheet" href="/style.css">

</head>

<body>
    <!-- ##### Header Area Start ##### -->
    <header class="header_area">
        <div class="classy-nav-container breakpoint-off d-flex align-items-center justify-content-between">
            <!-- Classy Menu -->
            <nav class="classy-navbar" id="essenceNav">
                <!-- Logo -->
                <a class="nav-brand" href="/index"><img src="/img/TĐT_logo.png" alt=""></a>
                <!-- Navbar Toggler -->
                <div class="classy-navbar-toggler">
                    <span class="navbarToggler"><span></span><span></span><span></span></span>
                </div>
                <!-- Menu -->
                <div class="classy-menu">
                    <!-- close btn -->
                    <div class="classycloseIcon">
                        <div class="cross-wrap"><span class="top"></span><span class="bottom"></span></div>
                    </div>
                    <!-- Nav Start -->
                    <div class="classynav">
                        <ul>
                            <li><a href="/index">Trang chủ</a></li>

                            <li><a href="/shop">Shop</a>

                            </li>
                            <li><a href="#">Pages</a>
                                <ul class="dropdown">
                                    <li><a href="/shop">Shop</a></li>
                                    <li><a href="/check-order">Kiểm tra đơn hàng</a></li>
                                </ul>
                            </li>
                            <li><a href="/check-order">Kiểm tra đơn hàng</a></li>
                        </ul>
                    </div>
                    <!-- Nav End -->
                </div>
            </nav>

            <!-- Header Meta Data -->
            <div class="header-meta d-flex clearfix justify-content-end">
                <!-- Search Area -->
                <div class="search-area">
                    <form action="/shop" method="get">
                        <input type="search" name="search" id="headerSearch" placeholder="Type for search"
                            value="{{search}}">
                        <button type="submit"><i class="fa fa-search" aria-hidden="true"></i></button>
                    </form>
                </div>
                <!-- Favourite Area -->
                <div class="favourite-area">
                    <a href="/favorite" style="display: flex; justify-content: center; align-items: center;"><img
                            src="img/core-img/heart.svg" alt=""></a>
                </div>
                <!-- User Login Info -->
                <div class="user-login-info" style="display: flex; justify-content: center; align-items: center;">
                    {{#if name}}
                    <span style="margin-right:10px ;">Chào, <b>{{name}}</b></span>
                    {{else}}
                    <a href="/cus/auth" style="display: flex; justify-content: center; align-items: center;"><img
                            src="img/core-img/user.svg" alt=""></a>
                    {{/if}}
                </div>

                <div class="user-login-info">
                    {{#if name}}
                    <a href="/cus/logout" style="display: flex; justify-content: center; align-items: center;"><img
                            src="img/logout.png" alt=""></a>
                    {{/if}}
                </div>
                <!-- Cart Area -->
                <div class="cart-area">
                    <a href="#" id="essenceCartBtn"
                        style="display: flex; justify-content: center; align-items: center;"><img
                            src="img/core-img/bag.svg" alt="">
                        <span id="cart-count" style="margin-left: 20px;">{{this.length}}</span></a>
                </div>
            </div>

        </div>
    </header>
    <!-- ##### Header Area End ##### -->

    <!-- ##### Right Side Cart Area ##### -->
    <div class="cart-bg-overlay"></div>

    <div class="right-side-cart-area">

        <!-- Cart Button -->
        <div class="cart-button">
            <a href="#" id="rightSideCart"><img src="/img/core-img/bag.svg" alt=""> <span>{{this.length}}</span></a>
        </div>

        <div class="cart-content d-flex">

            <!-- Cart List Area -->
            <div class="cart-list">
                <!-- Single Cart Item -->
                {{#if carts}}
                {{#each carts}}
                <div class="single-cart-item" style="margin-bottom: 10px;">
                    <a href="#" class="product-image">
                        <img src="/uploads/{{this.image}}" class="cart-thumb" alt="">
                        <!-- Cart Item Desc -->
                        <div class="cart-item-desc">
                            <span class="product-remove"><i class="fa fa-close" aria-hidden="true"
                                    data-product-id="{{this.id}}"></i></span>
                            <span class="badge">{{this.brand}}</span>
                            <h6>{{this.productName}}</h6>
                            <p class="size" style="font-size: 16px;">Số lượng:
                                <button class="quantity-button" data-action="decrease" data-product-id="{{this.id}}"> -
                                </button>
                                <span class="quantity"> {{this.quantity}} </span>
                                <button class="quantity-button" data-action="increase" data-product-id="{{this.id}}"> +
                                </button>
                            </p>
                            <p class="color"></p>
                            <p class="price">{{this.price}}</p>
                        </div>
                    </a>
                </div>
                {{/each}}
                {{else}}
                <h3 style="display: flex;
                    justify-content: center;
                    align-items: center;
                    margin-left: 20px;
                    height: 100vh; ">Giỏ hàng trống</h3>
                {{/if}}

            </div>

            <!-- Cart Summary -->
            <div class="cart-amount-summary">
                <div class="checkout-btn mt-100"
                    style="display: flex; justify-content: center; flex-direction: column; align-items: center;">
                    <a href="/checkout" class="btn essence-btn"
                        style="margin-top:  10px; background-color: black; display:none"> THực
                        hiện Thanh toán</a>
                    <h2 style="
                    margin-left: 20px;
                    height: 100vh;
                    display:none ">Hãy thêm sản phẩm vào giỏ hàng</h2>
                </div>
            </div>
        </div>
    </div>
    <!-- ##### Right Side Cart End ##### -->

    <!-- ##### Welcome Area Start ##### -->
    <section class="welcome_area bg-img background-overlay"
        style="background-image: url(/img/iphone-15-upgrade-sliding.webp); background-size: 95% 100%;">
        <div class="container h-100">
            <div class="row h-100 align-items-center" style="justify-content: flex-end;">
                <div class="col-4">
                    <div class="hero-content mt-2">
                        <h3>Apple</h3>
                        <h2>iPhone 15</h2>
                        <a href="/shop" class="btn essence-btn">Lên đời điện thoại</a>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- ##### Welcome Area End ##### -->

    <!-- ##### Top Catagory Area Start ##### -->
    <div class="top_catagory_area section-padding-80 clearfix">
        <div class="container">
            <div class="row justify-content-center">
                <!-- Single Catagory -->
                <div class="col-12 col-sm-6 col-md-4">
                    <div class="single_catagory_area d-flex align-items-center justify-content-center bg-img"
                        style="background-image: url(/img/bg-img/bg_phone.png); background-size: 90% 125%;">
                        <div class="catagory-content">
                            <a href="/shop?category=Điện%20thoại,%20Tablet">Điện thoại</a>
                        </div>
                    </div>
                </div>
                <!-- Single Catagory -->
                <div class="col-12 col-sm-6 col-md-4">
                    <div class="single_catagory_area d-flex align-items-center justify-content-center bg-img"
                        style="background-image: url(img/bg-img/bg_lap.jpeg); background-size: 90% 125%;">
                        <div class="catagory-content">
                            <a href="/shop?category=Laptop">Laptop</a>
                        </div>
                    </div>
                </div>
                <!-- Single Catagory -->
                <div class="col-12 col-sm-6 col-md-4">
                    <div class="single_catagory_area d-flex align-items-center justify-content-center bg-img"
                        style="background-image: url(img/bg-img/bg_pk.jpg); background-size: 90% 125%;">
                        <div class="catagory-content">
                            <a href="/shop?category=Phụ%20kiện">Phụ kiện</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- ##### Top Catagory Area End ##### -->

    <!-- ##### CTA Area Start ##### -->
    <div class="cta-area">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="cta-content bg-img background-overlay"
                        style="background-image: url(img/bg-img/bg_sale.jpg); background-size: 90% 125%;">
                        <div class="h-100 d-flex align-items-center justify-content-end">
                            <div class="cta--text">
                                <h6>-20%</h6>
                                <h2>Sale</h2>
                                <a href="/shop" class="btn essence-btn">Mua Ngay</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- ##### CTA Area End ##### -->

    <!-- ##### New Arrivals Area Start ##### -->
    <section class="new_arrivals_area section-padding-80 clearfix">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="section-heading text-center">
                        <h2>Popular Products</h2>
                    </div>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="popular-products-slides owl-carousel">
                        {{#each products }}
                        <!-- Single Product -->
                        <div class="single-product-wrapper">

                            <!-- Product Image -->
                            <div class="product-img">
                                <img src="/uploads/{{this.image}}" alt="">

                                <!-- Favourite -->
                                <div class="product-favourite">
                                    <a href="#" class="favme fa fa-heart"></a>
                                </div>
                            </div>

                            <!-- Product Description -->
                            <div class="product-description">
                                <span>{{this.brand}}</span>
                                <a href="/product-detail/{{this._id}}">
                                    <h6>{{this.name}}</h6>
                                </a>
                                <p class="product-price">
                                    {{!-- {{#ifeq minPriceColor.quantityInStock 0}}
                                    <span class="old-price">{{formatCurrency minPriceColor.price}}</span>
                                    <span style="color: red; text-decoration:none">Sản phẩm đã hết</span>
                                    {{else}} --}}
                                    {{formatCurrency this.minPrice}}
                                    {{!-- {{/ifeq}} --}}
                                </p>
                            </div>

                        </div>
                        {{/each}}





                    </div>
                </div>
            </div>
    </section>
    <!-- ##### New Arrivals Area End ##### -->

    <!-- ##### Brands Area Start ##### -->
    <div class="brands-area d-flex align-items-center justify-content-between">
        <!-- Brand Logo -->
        <div class="single-brands-logo">
            <img src="img/core-img/Apple_logo_black.svg" alt="" style="height: 100px;">
        </div>
        <!-- Brand Logo -->
        <div class="single-brands-logo">
            <img src="img/core-img/Samsung_Logo.svg" alt="">
        </div>
        <!-- Brand Logo -->
        <div class="single-brands-logo">
            <img src="img/core-img/Dell_logo_2016_black.svg" alt="">
        </div>
        <!-- Brand Logo -->
        <div class="single-brands-logo">
            <img src="img/core-img/Lenovo_idDXuX8rvi_1.svg" alt="">
        </div>
        <!-- Brand Logo -->
        <div class="single-brands-logo">
            <img src="img/core-img/Sony_idbwbZ4V9y_3.jpeg" alt="">
        </div>
        <!-- Brand Logo -->
        <div class="single-brands-logo">
            <img src="img/core-img/idlg-RxGTO_1711541071517.jpeg" alt="">
        </div>
    </div>
    <!-- ##### Brands Area End ##### -->

    <script id="kami-chat-widget" src="https://kamimind.ai/kami-chat-widget.js" token="rZq7YeQ4YK40O5WUcJlOH2D32kBuehpC"
        charset="utf-8" botToken="336290a4-88b3-43e8-ac45-82ace2518135" defer></script>
    <!-- ##### Footer Area Start ##### -->
    <footer class="footer_area clearfix">
        <div class="container">
            <div class="row">
                <!-- Single Widget Area -->
                <div class="col-12 col-md-6">
                    <div class="single_widget_area d-flex mb-30">
                        <!-- Logo -->
                        <div class="footer-logo mr-50">
                            <a href="#"><img src="/img/TĐT_logo.png" alt=""></a>
                        </div>
                        <!-- Footer Menu -->
                        <div class="footer_menu">
                            <ul>
                                <li><a href="shop.html">Shop</a></li>
                                <li><a href="blog.html">Blog</a></li>
                                <li><a href="contact.html">Contact</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <!-- Single Widget Area -->
                <div class="col-12 col-md-6">
                    <div class="single_widget_area mb-30">
                        <ul class="footer_widget_menu">
                            <li><a href="#">Order Status</a></li>
                            <li><a href="#">Payment Options</a></li>
                            <li><a href="#">Shipping and Delivery</a></li>
                            <li><a href="#">Guides</a></li>
                            <li><a href="#">Privacy Policy</a></li>
                            <li><a href="#">Terms of Use</a></li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="row align-items-end">
                <!-- Single Widget Area -->
                <div class="col-12 col-md-6">
                    <div class="single_widget_area">
                        <div class="footer_heading mb-30">
                            <h6>Subscribe</h6>
                        </div>
                        <div class="subscribtion_form">
                            <form action="#" method="post">
                                <input type="email" name="mail" class="mail" placeholder="Your email here">
                                <button type="submit" class="submit"><i class="fa fa-long-arrow-right"
                                        aria-hidden="true"></i></button>
                            </form>
                        </div>
                    </div>
                </div>
                <!-- Single Widget Area -->
                <div class="col-12 col-md-6">
                    <div class="single_widget_area">
                        <div class="footer_social_area">
                            <a href="#" data-toggle="tooltip" data-placement="top" title="Facebook"><i
                                    class="fa fa-facebook" aria-hidden="true"></i></a>
                            <a href="#" data-toggle="tooltip" data-placement="top" title="Instagram"><i
                                    class="fa fa-instagram" aria-hidden="true"></i></a>
                            <a href="#" data-toggle="tooltip" data-placement="top" title="Twitter"><i
                                    class="fa fa-twitter" aria-hidden="true"></i></a>
                            <a href="#" data-toggle="tooltip" data-placement="top" title="Pinterest"><i
                                    class="fa fa-pinterest" aria-hidden="true"></i></a>
                            <a href="#" data-toggle="tooltip" data-placement="top" title="Youtube"><i
                                    class="fa fa-youtube-play" aria-hidden="true"></i></a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-5">
                <div class="col-md-12 text-center">
                    <p>
                        <!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
                        Copyright &copy;
                        <script>document.write(new Date().getFullYear());</script> All rights reserved | Made with <i
                            class="fa fa-heart-o" aria-hidden="true"></i> by <a href="https://colorlib.com"
                            target="_blank">Colorlib</a>, distributed by <a href="https://themewagon.com/"
                            target="_blank">ThemeWagon</a>
                        <!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
                    </p>
                </div>
            </div>

        </div>
    </footer>
    <!-- ##### Footer Area End ##### -->

    <!-- jQuery (Necessary for All JavaScript Plugins) -->
    <script src="/js2/jquery/jquery-2.2.4.min.js"></script>
    <!-- Popper js -->
    <script src="/js2/popper.min.js"></script>
    <!-- Bootstrap js -->
    <script src="/js2/bootstrap.min.js"></script>
    <!-- Plugins js -->
    <script src="/js2/plugins.js"></script>
    <!-- Classy Nav js -->
    <script src="/js2/classy-nav.min.js"></script>
    <!-- Active js -->
    <script src="/js2/active.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>

    <!-- jQuery Easing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.4.1/jquery.easing.min.js"></script>

    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script>
        jQuery(document).ready(function () {
            if (parseInt(jQuery('.cart-button span').text()) == 0) {
                jQuery('.checkout-btn a').hide();
                jQuery('.checkout-btn h2').show();
            } else {
                jQuery('.checkout-btn a').show();
                jQuery('.checkout-btn h2').hide();
            }

            jQuery(document).on('click', '.product-remove', function () {
                jQuery(this).closest('.single-cart-item').remove();
                var productId = jQuery(this).find('i').data('product-id');
                console.log(productId);
                jQuery.ajax({
                    url: '/cart/delete',
                    method: 'Delete',
                    contentType: 'application/json',
                    data: JSON.stringify({ productId }),
                    success: function (response) {
                        console.log(response);
                        jQuery('#cart-count').text(response.cart.length);
                        jQuery('.cart-button span').text(response.cart.length);
                        if (response.cart.length == 0) {
                            jQuery('.checkout-btn a').hide();
                            jQuery('.checkout-btn h2').show();
                        } else {
                            jQuery('.checkout-btn a').show();
                            jQuery('.checkout-btn h2').hide();
                        }
                    },
                    error: function (err) {
                        console.log(err);
                    }
                });
            });

            function debounce(func, delay) {
                let debounceTimer;
                return function () {
                    const context = this;
                    const args = arguments;
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(() => func.apply(context, args), delay);
                }
            }

            const debounceUpdateQuantity = debounce(function (productId, quantityElement) {
                jQuery.ajax({
                    url: '/cart/updateQuantity',
                    method: 'put',
                    contentType: 'application/json',
                    data: JSON.stringify({ productId, quantityElement }),
                    success: function (response) {
                        console.log(response);
                        // Update the quantity on the page
                    },
                    error: function (err) {
                        console.log(err);
                        if (err.status === 400) {
                            alert('Số lượng sản phẩm không đủ. Chỉ còn ' + err.responseJSON.quantityInStock);
                            //quantityElement.text(err.responseJSON.quantityInStock);
                            window.location.reload();

                        }
                    }
                });
            }, 1000);

            jQuery(document).on('click', '.quantity-button', function () {
                var productId = jQuery(this).data('product-id');
                var action = jQuery(this).data('action');
                var quantityElement = jQuery(this).siblings('.quantity');
                var currentQuantity = parseInt(quantityElement.text());
                if (action === 'increase') {
                    quantityElement.text(currentQuantity + 1);
                } else if (action === 'decrease' && currentQuantity > 1) {
                    quantityElement.text(currentQuantity - 1);
                }

                var newQuantity = parseInt(quantityElement.text()); // Lấy giá trị mới của số lượng
                debounceUpdateQuantity(productId, newQuantity);
            });


            jQuery('.add-to-cart-btn2').on('click', function (e) {
                var productId = jQuery(this).data('product-id');
                var price = parseFloat(jQuery(this).data('product-price').replace(/\./g, ""));
                var quantity = 1;
                jQuery.ajax({
                    url: '/cart/add',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ productId, quantity, price }),
                    success: function (response) {
                        console.log(response);
                        updateCartUI(response.cart);
                    },
                    error: function (err) {
                        console.log(err);
                        if (err.status === 401) {
                            alert('Hãy đăng nhập để tiếp tục việc mua hàng');
                            setTimeout(function () {
                                window.location.href = '/cus/auth';
                            }, 1000);
                        } else if (err.status === 400) {
                            alert('Sản phẩm đã hết hàng');
                        } else {
                            alert('Đã có lỗi xảy ra');
                        }
                    }
                });
            });
        });

        // Function to update the cart UI
        function updateCartUI(cart) {
            jQuery('#cart-count').text(cart.items.length);
            jQuery('.cart-button span').text(cart.items.length);
            const cartItemsContainer = jQuery('#cart-items');
            cartItemsContainer.empty();
            if (cart.items.length > 0) {
                jQuery('.checkout-btn a').show();
                jQuery('.checkout-btn h2').hide();
            } else {
                jQuery('.checkout-btn a').hide();
                jQuery('.checkout-btn h2').show();
            }
            cart.items.forEach((item) => {
                const cartItemHTML = `
            <div class="single-cart-item" style="margin-bottom: 10px;">
                <a href="#" class="product-image">
                    <img src="/uploads/${item.image}" class="cart-thumb" alt="">
                    <!-- Cart Item Desc -->
                    <div class="cart-item-desc">
                        <span class="product-remove"><i class="fa fa-close" aria-hidden="true" data-product-id="${item.id}"></i></span>
                        <span class="badge">${item.brand}</span>
                        <h6>${item.productName}</h6>
                        <p class="size" style="font-size: 16px;">Số lượng:
                                <button class="quantity-button" data-action="decrease" data-product-id="${item.id}"> -
                                </button>
                                <span class="quantity"> ${item.quantity} </span>
                                <button class="quantity-button" data-action="increase" data-product-id="${item.id}"> +
                                </button>
                            </p>
                        <p class="color"></p>
                        <p class="price">${item.price}</p>
                    </div>
                </a>
            </div>
        `;
                cartItemsContainer.append(cartItemHTML);
            });

        }
    </script>
</body>

</html>